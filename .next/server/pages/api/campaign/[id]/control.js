"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "pages/api/campaign/[id]/control";
exports.ids = ["pages/api/campaign/[id]/control"];
exports.modules = {

/***/ "bullmq":
/*!*************************!*\
  !*** external "bullmq" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("bullmq");

/***/ }),

/***/ "ioredis":
/*!**************************!*\
  !*** external "ioredis" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("ioredis");

/***/ }),

/***/ "mongodb":
/*!**************************!*\
  !*** external "mongodb" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("mongodb");

/***/ }),

/***/ "next/dist/compiled/next-server/pages-api.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/pages-api.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/pages-api.runtime.dev.js");

/***/ }),

/***/ "(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fcampaign%2F%5Bid%5D%2Fcontrol&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Ccampaign%5C%5Bid%5D%5Ccontrol.ts&middlewareConfigBase64=e30%3D!":
/*!****************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fcampaign%2F%5Bid%5D%2Fcontrol&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Ccampaign%5C%5Bid%5D%5Ccontrol.ts&middlewareConfigBase64=e30%3D! ***!
  \****************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   routeModule: () => (/* binding */ routeModule)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/pages-api/module.compiled */ \"(api)/./node_modules/next/dist/server/future/route-modules/pages-api/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(api)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/build/templates/helpers */ \"(api)/./node_modules/next/dist/build/templates/helpers.js\");\n/* harmony import */ var _pages_api_campaign_id_control_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./pages\\api\\campaign\\[id]\\control.ts */ \"(api)/./pages/api/campaign/[id]/control.ts\");\n\n\n\n// Import the userland code.\n\n// Re-export the handler (should be the default export).\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_campaign_id_control_ts__WEBPACK_IMPORTED_MODULE_3__, \"default\"));\n// Re-export config.\nconst config = (0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_campaign_id_control_ts__WEBPACK_IMPORTED_MODULE_3__, \"config\");\n// Create and export the route module that will be consumed.\nconst routeModule = new next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.PAGES_API,\n        page: \"/api/campaign/[id]/control\",\n        pathname: \"/api/campaign/[id]/control\",\n        // The following aren't used in production.\n        bundlePath: \"\",\n        filename: \"\"\n    },\n    userland: _pages_api_campaign_id_control_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n\n//# sourceMappingURL=pages-api.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LXJvdXRlLWxvYWRlci9pbmRleC5qcz9raW5kPVBBR0VTX0FQSSZwYWdlPSUyRmFwaSUyRmNhbXBhaWduJTJGJTVCaWQlNUQlMkZjb250cm9sJnByZWZlcnJlZFJlZ2lvbj0mYWJzb2x1dGVQYWdlUGF0aD0uJTJGcGFnZXMlNUNhcGklNUNjYW1wYWlnbiU1QyU1QmlkJTVEJTVDY29udHJvbC50cyZtaWRkbGV3YXJlQ29uZmlnQmFzZTY0PWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDTDtBQUMxRDtBQUNxRTtBQUNyRTtBQUNBLGlFQUFlLHdFQUFLLENBQUMsOERBQVEsWUFBWSxFQUFDO0FBQzFDO0FBQ08sZUFBZSx3RUFBSyxDQUFDLDhEQUFRO0FBQ3BDO0FBQ08sd0JBQXdCLGdIQUFtQjtBQUNsRDtBQUNBLGNBQWMseUVBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxZQUFZO0FBQ1osQ0FBQzs7QUFFRCIsInNvdXJjZXMiOlsid2VicGFjazovL21hcmtldGluZy1tdnAvPzhjNzUiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFnZXNBUElSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL3BhZ2VzLWFwaS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBob2lzdCB9IGZyb20gXCJuZXh0L2Rpc3QvYnVpbGQvdGVtcGxhdGVzL2hlbHBlcnNcIjtcbi8vIEltcG9ydCB0aGUgdXNlcmxhbmQgY29kZS5cbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIuL3BhZ2VzXFxcXGFwaVxcXFxjYW1wYWlnblxcXFxbaWRdXFxcXGNvbnRyb2wudHNcIjtcbi8vIFJlLWV4cG9ydCB0aGUgaGFuZGxlciAoc2hvdWxkIGJlIHRoZSBkZWZhdWx0IGV4cG9ydCkuXG5leHBvcnQgZGVmYXVsdCBob2lzdCh1c2VybGFuZCwgXCJkZWZhdWx0XCIpO1xuLy8gUmUtZXhwb3J0IGNvbmZpZy5cbmV4cG9ydCBjb25zdCBjb25maWcgPSBob2lzdCh1c2VybGFuZCwgXCJjb25maWdcIik7XG4vLyBDcmVhdGUgYW5kIGV4cG9ydCB0aGUgcm91dGUgbW9kdWxlIHRoYXQgd2lsbCBiZSBjb25zdW1lZC5cbmV4cG9ydCBjb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBQYWdlc0FQSVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5QQUdFU19BUEksXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9jYW1wYWlnbi9baWRdL2NvbnRyb2xcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9jYW1wYWlnbi9baWRdL2NvbnRyb2xcIixcbiAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBhcmVuJ3QgdXNlZCBpbiBwcm9kdWN0aW9uLlxuICAgICAgICBidW5kbGVQYXRoOiBcIlwiLFxuICAgICAgICBmaWxlbmFtZTogXCJcIlxuICAgIH0sXG4gICAgdXNlcmxhbmRcbn0pO1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wYWdlcy1hcGkuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fcampaign%2F%5Bid%5D%2Fcontrol&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Ccampaign%5C%5Bid%5D%5Ccontrol.ts&middlewareConfigBase64=e30%3D!\n");

/***/ }),

/***/ "(api)/./lib/mongo.ts":
/*!**********************!*\
  !*** ./lib/mongo.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! mongodb */ \"mongodb\");\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(mongodb__WEBPACK_IMPORTED_MODULE_0__);\n// lib/mongo.ts\n\nconst uri = process.env.MONGODB_URI;\nif (!uri) throw new Error(\"MONGODB_URI not set\");\nlet client;\nlet clientPromise;\n// Retry logic in case MongoDB connection fails\nasync function connectWithRetry() {\n    const MAX_RETRIES = 5;\n    let attempts = 0;\n    let lastError = null;\n    while(attempts < MAX_RETRIES){\n        try {\n            const client = new mongodb__WEBPACK_IMPORTED_MODULE_0__.MongoClient(uri, {\n                maxPoolSize: 10,\n                serverSelectionTimeoutMS: 10000,\n                socketTimeoutMS: 45000\n            });\n            await client.connect();\n            return client;\n        } catch (err) {\n            lastError = err;\n            attempts++;\n            console.error(`MongoDB connection failed (attempt ${attempts}/${MAX_RETRIES}):`, err);\n            if (attempts < MAX_RETRIES) {\n                await new Promise((resolve)=>setTimeout(resolve, 5000)); // wait for 5 seconds before retrying\n            }\n        }\n    }\n    // After max retries, throw the last error encountered\n    throw lastError || new Error(\"MongoDB connection failed after maximum retry attempts\");\n}\nif (!global._mongoClientPromise) {\n    global._mongoClientPromise = connectWithRetry();\n    // Optional: log connection events\n    global._mongoClientPromise.then((client)=>{\n        client.on(\"serverOpening\", (event)=>console.log(\"MongoDB server opening\", event));\n        client.on(\"serverClosed\", (event)=>console.warn(\"MongoDB server closed\", event));\n        client.on(\"topologyClosed\", ()=>console.warn(\"MongoDB topology closed\"));\n        client.on(\"topologyOpening\", ()=>console.log(\"MongoDB topology opening\"));\n        client.on(\"error\", (err)=>console.error(\"MongoDB error\", err));\n    }).catch((err)=>{\n        console.error(\"MongoDB client failed to connect after retries\", err);\n    });\n}\nclientPromise = global._mongoClientPromise;\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (clientPromise);\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9saWIvbW9uZ28udHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZUFBZTtBQUN1QjtBQUV0QyxNQUFNQyxNQUFNQyxRQUFRQyxHQUFHLENBQUNDLFdBQVc7QUFDbkMsSUFBSSxDQUFDSCxLQUFLLE1BQU0sSUFBSUksTUFBTTtBQUUxQixJQUFJQztBQUNKLElBQUlDO0FBT0osK0NBQStDO0FBQy9DLGVBQWVDO0lBQ2IsTUFBTUMsY0FBYztJQUNwQixJQUFJQyxXQUFXO0lBQ2YsSUFBSUMsWUFBMEI7SUFFOUIsTUFBT0QsV0FBV0QsWUFBYTtRQUM3QixJQUFJO1lBQ0YsTUFBTUgsU0FBUyxJQUFJTixnREFBV0EsQ0FBQ0MsS0FBSztnQkFDbENXLGFBQWE7Z0JBQ2JDLDBCQUEwQjtnQkFDMUJDLGlCQUFpQjtZQUNuQjtZQUNBLE1BQU1SLE9BQU9TLE9BQU87WUFDcEIsT0FBT1Q7UUFDVCxFQUFFLE9BQU9VLEtBQVU7WUFDakJMLFlBQVlLO1lBQ1pOO1lBQ0FPLFFBQVFDLEtBQUssQ0FBQyxDQUFDLG1DQUFtQyxFQUFFUixTQUFTLENBQUMsRUFBRUQsWUFBWSxFQUFFLENBQUMsRUFBRU87WUFDakYsSUFBSU4sV0FBV0QsYUFBYTtnQkFDMUIsTUFBTSxJQUFJVSxRQUFRQyxDQUFBQSxVQUFXQyxXQUFXRCxTQUFTLFFBQVEscUNBQXFDO1lBQ2hHO1FBQ0Y7SUFDRjtJQUVBLHNEQUFzRDtJQUN0RCxNQUFNVCxhQUFhLElBQUlOLE1BQU07QUFDL0I7QUFFQSxJQUFJLENBQUNpQixPQUFPQyxtQkFBbUIsRUFBRTtJQUMvQkQsT0FBT0MsbUJBQW1CLEdBQUdmO0lBRTdCLGtDQUFrQztJQUNsQ2MsT0FBT0MsbUJBQW1CLENBQ3ZCQyxJQUFJLENBQUNsQixDQUFBQTtRQUNKQSxPQUFPbUIsRUFBRSxDQUFDLGlCQUFpQixDQUFDQyxRQUFVVCxRQUFRVSxHQUFHLENBQUMsMEJBQTBCRDtRQUM1RXBCLE9BQU9tQixFQUFFLENBQUMsZ0JBQWdCLENBQUNDLFFBQVVULFFBQVFXLElBQUksQ0FBQyx5QkFBeUJGO1FBQzNFcEIsT0FBT21CLEVBQUUsQ0FBQyxrQkFBa0IsSUFBTVIsUUFBUVcsSUFBSSxDQUFDO1FBQy9DdEIsT0FBT21CLEVBQUUsQ0FBQyxtQkFBbUIsSUFBTVIsUUFBUVUsR0FBRyxDQUFDO1FBQy9DckIsT0FBT21CLEVBQUUsQ0FBQyxTQUFTLENBQUNULE1BQVFDLFFBQVFDLEtBQUssQ0FBQyxpQkFBaUJGO0lBQzdELEdBQ0NhLEtBQUssQ0FBQ2IsQ0FBQUE7UUFDTEMsUUFBUUMsS0FBSyxDQUFDLGtEQUFrREY7SUFDbEU7QUFDSjtBQUVBVCxnQkFBZ0JlLE9BQU9DLG1CQUFtQjtBQUUxQyxpRUFBZWhCLGFBQWFBLEVBQUMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9tYXJrZXRpbmctbXZwLy4vbGliL21vbmdvLnRzPzU3ZmUiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gbGliL21vbmdvLnRzXHJcbmltcG9ydCB7IE1vbmdvQ2xpZW50IH0gZnJvbSAnbW9uZ29kYic7XHJcblxyXG5jb25zdCB1cmkgPSBwcm9jZXNzLmVudi5NT05HT0RCX1VSSTtcclxuaWYgKCF1cmkpIHRocm93IG5ldyBFcnJvcignTU9OR09EQl9VUkkgbm90IHNldCcpO1xyXG5cclxubGV0IGNsaWVudDogTW9uZ29DbGllbnQ7XHJcbmxldCBjbGllbnRQcm9taXNlOiBQcm9taXNlPE1vbmdvQ2xpZW50PjtcclxuXHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdmFyXHJcbiAgdmFyIF9tb25nb0NsaWVudFByb21pc2U6IFByb21pc2U8TW9uZ29DbGllbnQ+IHwgdW5kZWZpbmVkO1xyXG59XHJcblxyXG4vLyBSZXRyeSBsb2dpYyBpbiBjYXNlIE1vbmdvREIgY29ubmVjdGlvbiBmYWlsc1xyXG5hc3luYyBmdW5jdGlvbiBjb25uZWN0V2l0aFJldHJ5KCk6IFByb21pc2U8TW9uZ29DbGllbnQ+IHtcclxuICBjb25zdCBNQVhfUkVUUklFUyA9IDU7XHJcbiAgbGV0IGF0dGVtcHRzID0gMDtcclxuICBsZXQgbGFzdEVycm9yOiBFcnJvciB8IG51bGwgPSBudWxsO1xyXG5cclxuICB3aGlsZSAoYXR0ZW1wdHMgPCBNQVhfUkVUUklFUykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgY2xpZW50ID0gbmV3IE1vbmdvQ2xpZW50KHVyaSwge1xyXG4gICAgICAgIG1heFBvb2xTaXplOiAxMCxcclxuICAgICAgICBzZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0TVM6IDEwMDAwLFxyXG4gICAgICAgIHNvY2tldFRpbWVvdXRNUzogNDUwMDAsXHJcbiAgICAgIH0pO1xyXG4gICAgICBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xyXG4gICAgICByZXR1cm4gY2xpZW50O1xyXG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcclxuICAgICAgbGFzdEVycm9yID0gZXJyO1xyXG4gICAgICBhdHRlbXB0cysrO1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBNb25nb0RCIGNvbm5lY3Rpb24gZmFpbGVkIChhdHRlbXB0ICR7YXR0ZW1wdHN9LyR7TUFYX1JFVFJJRVN9KTpgLCBlcnIpO1xyXG4gICAgICBpZiAoYXR0ZW1wdHMgPCBNQVhfUkVUUklFUykge1xyXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDAwKSk7IC8vIHdhaXQgZm9yIDUgc2Vjb25kcyBiZWZvcmUgcmV0cnlpbmdcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gQWZ0ZXIgbWF4IHJldHJpZXMsIHRocm93IHRoZSBsYXN0IGVycm9yIGVuY291bnRlcmVkXHJcbiAgdGhyb3cgbGFzdEVycm9yIHx8IG5ldyBFcnJvcignTW9uZ29EQiBjb25uZWN0aW9uIGZhaWxlZCBhZnRlciBtYXhpbXVtIHJldHJ5IGF0dGVtcHRzJyk7XHJcbn1cclxuXHJcbmlmICghZ2xvYmFsLl9tb25nb0NsaWVudFByb21pc2UpIHtcclxuICBnbG9iYWwuX21vbmdvQ2xpZW50UHJvbWlzZSA9IGNvbm5lY3RXaXRoUmV0cnkoKTtcclxuICBcclxuICAvLyBPcHRpb25hbDogbG9nIGNvbm5lY3Rpb24gZXZlbnRzXHJcbiAgZ2xvYmFsLl9tb25nb0NsaWVudFByb21pc2VcclxuICAgIC50aGVuKGNsaWVudCA9PiB7XHJcbiAgICAgIGNsaWVudC5vbignc2VydmVyT3BlbmluZycsIChldmVudCkgPT4gY29uc29sZS5sb2coJ01vbmdvREIgc2VydmVyIG9wZW5pbmcnLCBldmVudCkpO1xyXG4gICAgICBjbGllbnQub24oJ3NlcnZlckNsb3NlZCcsIChldmVudCkgPT4gY29uc29sZS53YXJuKCdNb25nb0RCIHNlcnZlciBjbG9zZWQnLCBldmVudCkpO1xyXG4gICAgICBjbGllbnQub24oJ3RvcG9sb2d5Q2xvc2VkJywgKCkgPT4gY29uc29sZS53YXJuKCdNb25nb0RCIHRvcG9sb2d5IGNsb3NlZCcpKTtcclxuICAgICAgY2xpZW50Lm9uKCd0b3BvbG9neU9wZW5pbmcnLCAoKSA9PiBjb25zb2xlLmxvZygnTW9uZ29EQiB0b3BvbG9neSBvcGVuaW5nJykpO1xyXG4gICAgICBjbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4gY29uc29sZS5lcnJvcignTW9uZ29EQiBlcnJvcicsIGVycikpO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChlcnIgPT4ge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdNb25nb0RCIGNsaWVudCBmYWlsZWQgdG8gY29ubmVjdCBhZnRlciByZXRyaWVzJywgZXJyKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5jbGllbnRQcm9taXNlID0gZ2xvYmFsLl9tb25nb0NsaWVudFByb21pc2U7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGllbnRQcm9taXNlOyJdLCJuYW1lcyI6WyJNb25nb0NsaWVudCIsInVyaSIsInByb2Nlc3MiLCJlbnYiLCJNT05HT0RCX1VSSSIsIkVycm9yIiwiY2xpZW50IiwiY2xpZW50UHJvbWlzZSIsImNvbm5lY3RXaXRoUmV0cnkiLCJNQVhfUkVUUklFUyIsImF0dGVtcHRzIiwibGFzdEVycm9yIiwibWF4UG9vbFNpemUiLCJzZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0TVMiLCJzb2NrZXRUaW1lb3V0TVMiLCJjb25uZWN0IiwiZXJyIiwiY29uc29sZSIsImVycm9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwiZ2xvYmFsIiwiX21vbmdvQ2xpZW50UHJvbWlzZSIsInRoZW4iLCJvbiIsImV2ZW50IiwibG9nIiwid2FybiIsImNhdGNoIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./lib/mongo.ts\n");

/***/ }),

/***/ "(api)/./lib/redis.ts":
/*!**********************!*\
  !*** ./lib/redis.ts ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   redis: () => (/* binding */ redis)\n/* harmony export */ });\n/* harmony import */ var ioredis__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ioredis */ \"ioredis\");\n/* harmony import */ var ioredis__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(ioredis__WEBPACK_IMPORTED_MODULE_0__);\n// lib/redis.ts\n\nconst redis = new (ioredis__WEBPACK_IMPORTED_MODULE_0___default())(process.env.REDIS_URL || \"redis://127.0.0.1:6379\", {\n    maxRetriesPerRequest: null,\n    lazyConnect: true,\n    reconnectOnError: (err)=>{\n        // reconnect on most errors\n        const targetErrors = [\n            \"READONLY\",\n            \"ECONNRESET\",\n            \"ETIMEDOUT\"\n        ];\n        if (targetErrors.some((e)=>err.message.includes(e))) return true;\n        return false;\n    }\n});\n// Optional: log Redis connection events for observability\nredis.on(\"connect\", ()=>console.log(\"Redis connected\"));\nredis.on(\"ready\", ()=>console.log(\"Redis ready\"));\nredis.on(\"error\", (err)=>console.error(\"Redis error\", err));\nredis.on(\"close\", ()=>console.warn(\"Redis connection closed\"));\nredis.on(\"reconnecting\", ()=>console.log(\"Redis reconnecting\"));\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9saWIvcmVkaXMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZUFBZTtBQUVlO0FBRXZCLE1BQU1DLFFBQVEsSUFBSUQsZ0RBQU9BLENBQUNFLFFBQVFDLEdBQUcsQ0FBQ0MsU0FBUyxJQUFJLDBCQUEwQjtJQUNsRkMsc0JBQXNCO0lBQ3RCQyxhQUFhO0lBQ2JDLGtCQUFrQixDQUFDQztRQUNqQiwyQkFBMkI7UUFDM0IsTUFBTUMsZUFBZTtZQUFDO1lBQVk7WUFBYztTQUFZO1FBQzVELElBQUlBLGFBQWFDLElBQUksQ0FBQ0MsQ0FBQUEsSUFBS0gsSUFBSUksT0FBTyxDQUFDQyxRQUFRLENBQUNGLEtBQUssT0FBTztRQUM1RCxPQUFPO0lBQ1Q7QUFDRixHQUFHO0FBRUgsMERBQTBEO0FBQzFEVixNQUFNYSxFQUFFLENBQUMsV0FBVyxJQUFNQyxRQUFRQyxHQUFHLENBQUM7QUFDdENmLE1BQU1hLEVBQUUsQ0FBQyxTQUFTLElBQU1DLFFBQVFDLEdBQUcsQ0FBQztBQUNwQ2YsTUFBTWEsRUFBRSxDQUFDLFNBQVMsQ0FBQ04sTUFBUU8sUUFBUUUsS0FBSyxDQUFDLGVBQWVUO0FBQ3hEUCxNQUFNYSxFQUFFLENBQUMsU0FBUyxJQUFNQyxRQUFRRyxJQUFJLENBQUM7QUFDckNqQixNQUFNYSxFQUFFLENBQUMsZ0JBQWdCLElBQU1DLFFBQVFDLEdBQUcsQ0FBQyIsInNvdXJjZXMiOlsid2VicGFjazovL21hcmtldGluZy1tdnAvLi9saWIvcmVkaXMudHM/NTFlOSJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBsaWIvcmVkaXMudHNcclxuXHJcbmltcG9ydCBJT1JlZGlzIGZyb20gJ2lvcmVkaXMnO1xyXG5cclxuZXhwb3J0IGNvbnN0IHJlZGlzID0gbmV3IElPUmVkaXMocHJvY2Vzcy5lbnYuUkVESVNfVVJMIHx8ICdyZWRpczovLzEyNy4wLjAuMTo2Mzc5Jywge1xyXG4gIG1heFJldHJpZXNQZXJSZXF1ZXN0OiBudWxsLFxyXG4gIGxhenlDb25uZWN0OiB0cnVlLCAgICAgICAgICAgLy8gcHJldmVudHMgaW1tZWRpYXRlIGNvbm5lY3Rpb24gb24gaW1wb3J0XHJcbiAgcmVjb25uZWN0T25FcnJvcjogKGVycikgPT4ge1xyXG4gICAgLy8gcmVjb25uZWN0IG9uIG1vc3QgZXJyb3JzXHJcbiAgICBjb25zdCB0YXJnZXRFcnJvcnMgPSBbJ1JFQURPTkxZJywgJ0VDT05OUkVTRVQnLCAnRVRJTUVET1VUJ107XHJcbiAgICBpZiAodGFyZ2V0RXJyb3JzLnNvbWUoZSA9PiBlcnIubWVzc2FnZS5pbmNsdWRlcyhlKSkpIHJldHVybiB0cnVlO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH0sXHJcbn0pO1xyXG5cclxuLy8gT3B0aW9uYWw6IGxvZyBSZWRpcyBjb25uZWN0aW9uIGV2ZW50cyBmb3Igb2JzZXJ2YWJpbGl0eVxyXG5yZWRpcy5vbignY29ubmVjdCcsICgpID0+IGNvbnNvbGUubG9nKCdSZWRpcyBjb25uZWN0ZWQnKSk7XHJcbnJlZGlzLm9uKCdyZWFkeScsICgpID0+IGNvbnNvbGUubG9nKCdSZWRpcyByZWFkeScpKTtcclxucmVkaXMub24oJ2Vycm9yJywgKGVycikgPT4gY29uc29sZS5lcnJvcignUmVkaXMgZXJyb3InLCBlcnIpKTtcclxucmVkaXMub24oJ2Nsb3NlJywgKCkgPT4gY29uc29sZS53YXJuKCdSZWRpcyBjb25uZWN0aW9uIGNsb3NlZCcpKTtcclxucmVkaXMub24oJ3JlY29ubmVjdGluZycsICgpID0+IGNvbnNvbGUubG9nKCdSZWRpcyByZWNvbm5lY3RpbmcnKSk7Il0sIm5hbWVzIjpbIklPUmVkaXMiLCJyZWRpcyIsInByb2Nlc3MiLCJlbnYiLCJSRURJU19VUkwiLCJtYXhSZXRyaWVzUGVyUmVxdWVzdCIsImxhenlDb25uZWN0IiwicmVjb25uZWN0T25FcnJvciIsImVyciIsInRhcmdldEVycm9ycyIsInNvbWUiLCJlIiwibWVzc2FnZSIsImluY2x1ZGVzIiwib24iLCJjb25zb2xlIiwibG9nIiwiZXJyb3IiLCJ3YXJuIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./lib/redis.ts\n");

/***/ }),

/***/ "(api)/./pages/api/campaign/[id]/control.ts":
/*!********************************************!*\
  !*** ./pages/api/campaign/[id]/control.ts ***!
  \********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (/* binding */ handler)\n/* harmony export */ });\n/* harmony import */ var _lib_mongo__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../../../lib/mongo */ \"(api)/./lib/mongo.ts\");\n/* harmony import */ var _lib_redis__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../../lib/redis */ \"(api)/./lib/redis.ts\");\n/* harmony import */ var bullmq__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! bullmq */ \"bullmq\");\n/* harmony import */ var bullmq__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(bullmq__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! mongodb */ \"mongodb\");\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(mongodb__WEBPACK_IMPORTED_MODULE_3__);\n\n\n\n\nconst queue = new bullmq__WEBPACK_IMPORTED_MODULE_2__.Queue(\"campaigns\", {\n    connection: _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis\n});\n// keep parity with worker; allow env override\nconst MAX_ATTEMPTS = Number(process.env.MAX_ATTEMPTS || 3);\n// server-side cap for batch retries per request\nconst BATCH_RETRY_LIMIT = Number(process.env.BATCH_RETRY_LIMIT || 5000);\nasync function safeHSet(key, obj) {\n    try {\n        await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hset(key, obj);\n    } catch (err) {\n        console.warn(\"Redis unavailable while setting meta\", err);\n    }\n}\nasync function safePublish(channel, payload) {\n    try {\n        await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.publish(channel, JSON.stringify(payload));\n    } catch (err) {\n        console.warn(\"Redis publish failed\", err);\n    }\n}\n// Remove waiting/delayed/active jobs for a campaignId (best-effort)\nasync function removeQueuedJobsForCampaign(campaignId) {\n    try {\n        // get waiting/delayed/active jobs\n        const jobs = await queue.getJobs([\n            \"waiting\",\n            \"delayed\",\n            \"active\",\n            \"paused\"\n        ], 0, -1);\n        const matched = jobs.filter((j)=>{\n            try {\n                return j.data?.campaignId === campaignId;\n            } catch  {\n                return false;\n            }\n        });\n        for (const j of matched){\n            try {\n                // if the job is active, remove may fail - still try\n                await j.remove();\n            } catch (e) {\n                // best-effort — ignore\n                console.warn(`Failed to remove job ${j.id}`, e);\n            }\n        }\n        return matched.length;\n    } catch (err) {\n        console.warn(\"Failed to enumerate/remove jobs for campaign\", err);\n        return 0;\n    }\n}\n// safe read of redis meta integer field\nasync function safeGetMetaInt(redisKey, field) {\n    try {\n        const v = await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hget(redisKey, field);\n        return Number(v || 0);\n    } catch (e) {\n        return 0;\n    }\n}\n/**\r\n * Ensure there is a usable `campaign:{id}:definition` in Redis.\r\n * If missing, attempt to construct one from the Mongo campaign document.\r\n * Returns true if definition exists or was written successfully.\r\n */ async function ensureCampaignDefinition(id, campaignDoc) {\n    const key = `campaign:${id}:definition`;\n    try {\n        const existing = await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.get(key);\n        if (existing) return true;\n        // Attempt to build a minimal compatible definition\n        // Worker expects { initial: { subject, body }, followUps: [...] }\n        let built = null;\n        // Prefer explicit shapes commonly used\n        if (campaignDoc?.definition && typeof campaignDoc.definition === \"object\") {\n            built = campaignDoc.definition;\n        } else if (campaignDoc?.initial && typeof campaignDoc.initial === \"object\") {\n            built = {\n                initial: campaignDoc.initial,\n                followUps: campaignDoc.followUps || []\n            };\n        } else if (campaignDoc?.template && typeof campaignDoc.template === \"object\") {\n            built = {\n                initial: {\n                    subject: campaignDoc.template.subject || campaignDoc.name,\n                    body: campaignDoc.template.body || campaignDoc.content || \"\"\n                },\n                followUps: campaignDoc.template.followUps || campaignDoc.followUps || []\n            };\n        } else {\n            // fallback: try to glean subject/body from common fields\n            const subject = campaignDoc?.subject || campaignDoc?.title || campaignDoc?.name || `Campaign ${id}`;\n            const body = campaignDoc?.body || campaignDoc?.content || campaignDoc?.html || \"\";\n            const followUps = campaignDoc?.followUps || campaignDoc?.steps || [];\n            built = {\n                initial: {\n                    subject,\n                    body\n                },\n                followUps\n            };\n        }\n        // If built doesn't look right (no initial subject/body), fail safe\n        if (!built || !built.initial || built.initial.subject == null && built.initial.body == null) {\n            console.warn(\"Unable to construct campaign definition from campaign document\", {\n                campaignId: id,\n                sample: campaignDoc ? Object.keys(campaignDoc).slice(0, 8) : null\n            });\n            return false;\n        }\n        // Persist into Redis (no expiry) so worker can read it\n        try {\n            await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.set(key, JSON.stringify(built));\n            console.log(`Wrote fallback campaign definition into redis for ${id}`);\n            return true;\n        } catch (e) {\n            console.warn(\"Failed to write campaign definition to redis\", e);\n            return false;\n        }\n    } catch (e) {\n        console.warn(\"Error checking/writing campaign definition in redis\", e);\n        return false;\n    }\n}\nasync function handler(req, res) {\n    if (req.method !== \"POST\") {\n        return res.status(405).json({\n            error: \"Method not allowed\"\n        });\n    }\n    const { id } = req.query;\n    if (!id || typeof id !== \"string\") {\n        return res.status(400).json({\n            error: \"Invalid campaign id\"\n        });\n    }\n    const { action, confirm, contactId } = req.body;\n    if (!action || ![\n        \"pause\",\n        \"resume\",\n        \"cancel\",\n        \"delete\",\n        \"retryFailed\",\n        \"retryContact\"\n    ].includes(action)) {\n        return res.status(400).json({\n            error: \"Invalid action\"\n        });\n    }\n    const client = await _lib_mongo__WEBPACK_IMPORTED_MODULE_0__[\"default\"];\n    const db = client.db(\"PlatformData\");\n    const campaignObjectId = new mongodb__WEBPACK_IMPORTED_MODULE_3__.ObjectId(id);\n    try {\n        // Reload campaign from Mongo (authoritative)\n        const campaign = await db.collection(\"campaigns\").findOne({\n            _id: campaignObjectId\n        });\n        if (!campaign) {\n            return res.status(404).json({\n                error: \"Campaign not found\"\n            });\n        }\n        // Lightweight helpers\n        const redisKey = `campaign:${id}:meta`;\n        // ACTION: Pause\n        if (action === \"pause\") {\n            if (campaign.status === \"paused\") {\n                return res.status(200).json({\n                    ok: true,\n                    message: \"Already paused\"\n                });\n            }\n            await db.collection(\"campaigns\").updateOne({\n                _id: campaignObjectId\n            }, {\n                $set: {\n                    status: \"paused\"\n                }\n            });\n            await safeHSet(redisKey, {\n                status: \"paused\"\n            });\n            await safePublish(\"campaign:new\", {\n                id,\n                status: \"paused\"\n            });\n            return res.status(200).json({\n                ok: true,\n                action: \"paused\"\n            });\n        }\n        // ACTION: Resume\n        if (action === \"resume\") {\n            if (campaign.status === \"running\") {\n                return res.status(200).json({\n                    ok: true,\n                    message: \"Already running\"\n                });\n            }\n            await db.collection(\"campaigns\").updateOne({\n                _id: campaignObjectId\n            }, {\n                $set: {\n                    status: \"running\"\n                }\n            });\n            await safeHSet(redisKey, {\n                status: \"running\"\n            });\n            await safePublish(\"campaign:new\", {\n                id,\n                status: \"running\"\n            });\n            return res.status(200).json({\n                ok: true,\n                action: \"resumed\"\n            });\n        }\n        // ACTION: Cancel\n        if (action === \"cancel\") {\n            if (campaign.status === \"cancelled\") {\n                return res.status(200).json({\n                    ok: true,\n                    message: \"Already cancelled\"\n                });\n            }\n            // 1) Mark campaign cancelled and completedAt\n            const completedAt = new Date();\n            await db.collection(\"campaigns\").updateOne({\n                _id: campaignObjectId\n            }, {\n                $set: {\n                    status: \"cancelled\",\n                    completedAt\n                }\n            });\n            await safeHSet(redisKey, {\n                status: \"cancelled\"\n            });\n            // 2) Find and atomically mark pending ledger rows as failed (single updateMany)\n            const filter = {\n                campaignId: campaignObjectId,\n                status: \"pending\"\n            };\n            const update = {\n                $set: {\n                    status: \"failed\",\n                    lastError: \"cancelled\",\n                    lastAttemptAt: completedAt\n                },\n                $inc: {\n                    attempts: 1\n                }\n            };\n            const updateResult = await db.collection(\"campaign_contacts\").updateMany(filter, update);\n            const cancelledCount = updateResult.modifiedCount ?? 0;\n            // 3) Update Redis counters (best-effort)\n            try {\n                if (cancelledCount > 0) {\n                    await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hincrby(redisKey, \"processed\", cancelledCount);\n                    await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hincrby(redisKey, \"failed\", cancelledCount);\n                }\n            } catch (e) {\n                console.warn(\"Failed to update redis counters during cancel\", e);\n            }\n            // 4) Persist totals snapshot to campaigns.totals (read redis if available, fallback to db)\n            let meta = {};\n            try {\n                meta = await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hgetall(redisKey) || {};\n            } catch  {\n                meta = {};\n            }\n            // Compute totals final values combining persisted totals and our cancelledCount as fallback\n            const processedNow = Number(meta[\"processed\"] ?? (campaign.totals?.processed ?? 0) + cancelledCount);\n            const sentNow = Number(meta[\"sent\"] ?? campaign.totals?.sent ?? 0);\n            const failedNow = Number(meta[\"failed\"] ?? (campaign.totals?.failed ?? 0) + cancelledCount);\n            await db.collection(\"campaigns\").updateOne({\n                _id: campaignObjectId\n            }, {\n                $set: {\n                    \"totals.processed\": processedNow,\n                    \"totals.sent\": sentNow,\n                    \"totals.failed\": failedNow,\n                    completedAt\n                }\n            });\n            // 5) Remove queued jobs for this campaign (best-effort)\n            const removedJobs = await removeQueuedJobsForCampaign(id);\n            // 6) Publish event\n            await safePublish(\"campaign:new\", {\n                id,\n                status: \"cancelled\",\n                cancelledCount,\n                removedJobs\n            });\n            return res.status(200).json({\n                ok: true,\n                action: \"cancelled\",\n                cancelledCount,\n                removedJobs\n            });\n        }\n        // ACTION: Delete\n        if (action === \"delete\") {\n            // Require explicit confirmation — safeguards in UI must set confirm=true\n            if (confirm !== true) {\n                return res.status(400).json({\n                    error: \"Deletion requires confirm=true in request body\"\n                });\n            }\n            // Prevent accidental deletion while running\n            if (campaign.status === \"running\") {\n                return res.status(400).json({\n                    error: \"Cancel the campaign before deletion\"\n                });\n            }\n            // Remove queued jobs (best-effort)\n            const removedJobs = await removeQueuedJobsForCampaign(id);\n            // Delete Redis keys (best-effort)\n            try {\n                await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.del(`campaign:${id}:meta`);\n                await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.del(`campaign:${id}:definition`);\n                await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.srem(\"campaign:all\", id);\n            } catch (e) {\n                console.warn(\"Redis cleanup on delete failed\", e);\n            }\n            // Delete Mongo docs\n            const [campaignDel, ledgerDel] = await Promise.all([\n                db.collection(\"campaigns\").deleteOne({\n                    _id: campaignObjectId\n                }),\n                db.collection(\"campaign_contacts\").deleteMany({\n                    campaignId: campaignObjectId\n                })\n            ]);\n            await safePublish(\"campaign:new\", {\n                id,\n                status: \"deleted\"\n            });\n            return res.status(200).json({\n                ok: true,\n                action: \"deleted\",\n                campaignDeleted: campaignDel.deletedCount ?? 0,\n                ledgerDeleted: ledgerDel.deletedCount ?? 0,\n                removedJobs\n            });\n        }\n        // ACTION: Retry all failed contacts that are below MAX_ATTEMPTS\n        if (action === \"retryFailed\") {\n            // Disallow retrying if campaign is cancelled/deleted\n            if (campaign.status === \"cancelled\" || campaign.status === \"deleted\") {\n                return res.status(400).json({\n                    error: \"Cannot retry contacts for cancelled/deleted campaign\"\n                });\n            }\n            // Ensure a Redis campaign definition exists (worker requires it)\n            const hasDef = await ensureCampaignDefinition(id, campaign);\n            if (!hasDef) {\n                return res.status(500).json({\n                    error: \"Missing campaign definition in Redis and unable to construct one from campaign document. Retry cannot proceed.\"\n                });\n            }\n            // find failed contacts with attempts < MAX_ATTEMPTS\n            const filter = {\n                campaignId: campaignObjectId,\n                status: \"failed\",\n                attempts: {\n                    $lt: MAX_ATTEMPTS\n                }\n            };\n            const failedDocs = await db.collection(\"campaign_contacts\").find(filter, {\n                projection: {\n                    _id: 1,\n                    contactId: 1,\n                    step: 1\n                }\n            }).toArray();\n            const toRetryCount = failedDocs.length;\n            if (toRetryCount === 0) {\n                return res.status(200).json({\n                    ok: true,\n                    retried: 0,\n                    message: \"No eligible failed contacts to retry\"\n                });\n            }\n            // server-side cap enforcement\n            if (toRetryCount > BATCH_RETRY_LIMIT) {\n                return res.status(400).json({\n                    error: \"Batch retry exceeds server limit\",\n                    message: `Trying to retry ${toRetryCount} contacts exceeds server cap of ${BATCH_RETRY_LIMIT}. Use pagination to retry in smaller batches.`,\n                    toRetryCount,\n                    limit: BATCH_RETRY_LIMIT\n                });\n            }\n            // Atomically mark them pending (a single updateMany)\n            const updateResult = await db.collection(\"campaign_contacts\").updateMany(filter, {\n                $set: {\n                    status: \"pending\",\n                    lastError: null\n                }\n            });\n            const updated = updateResult.modifiedCount ?? 0;\n            // Enqueue jobs (batch)\n            const jobs = [];\n            const CHUNK = 200; // reasonable chunking\n            for(let i = 0; i < failedDocs.length; i += CHUNK){\n                const chunk = failedDocs.slice(i, i + CHUNK);\n                for (const doc of chunk){\n                    const contactObjId = doc.contactId ? doc.contactId : doc._id;\n                    // Determine job name and payload: prefer step payload when present\n                    try {\n                        if (doc.step) {\n                            jobs.push(queue.add(\"followup\", {\n                                campaignId: id,\n                                contactId: contactObjId.toString ? contactObjId.toString() : String(contactObjId),\n                                step: doc.step\n                            }, {\n                                removeOnComplete: true,\n                                removeOnFail: true\n                            }));\n                        } else {\n                            jobs.push(queue.add(\"initial\", {\n                                campaignId: id,\n                                contactId: contactObjId.toString ? contactObjId.toString() : String(contactObjId)\n                            }, {\n                                removeOnComplete: true,\n                                removeOnFail: true\n                            }));\n                        }\n                    } catch (e) {\n                        console.warn(\"Failed to queue job for retryFailed chunk item\", e);\n                    }\n                }\n            }\n            // Wait for enqueues (best-effort)\n            try {\n                await Promise.all(jobs);\n            } catch (e) {\n                console.warn(\"Some queue.add calls failed during retryFailed\", e);\n            }\n            // Update redis counters: decrease failed by updated (best-effort, but avoid negative)\n            try {\n                const currentFailed = await safeGetMetaInt(redisKey, \"failed\");\n                const dec = Math.min(updated, currentFailed);\n                if (dec > 0) {\n                    await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hincrby(redisKey, \"failed\", -dec);\n                }\n            } catch (e) {\n                console.warn(\"Failed to update redis counters during retryFailed\", e);\n            }\n            await safePublish(\"campaign:new\", {\n                id,\n                action: \"retryFailed\",\n                retried: updated\n            });\n            return res.status(200).json({\n                ok: true,\n                retried: updated,\n                attemptedEnqueue: toRetryCount\n            });\n        }\n        // ACTION: Retry a single failed contact by contactId\n        if (action === \"retryContact\") {\n            if (!contactId || typeof contactId !== \"string\") {\n                return res.status(400).json({\n                    error: \"Missing contactId for retryContact\"\n                });\n            }\n            // Disallow retrying if campaign is cancelled/deleted\n            if (campaign.status === \"cancelled\" || campaign.status === \"deleted\") {\n                return res.status(400).json({\n                    error: \"Cannot retry contacts for cancelled/deleted campaign\"\n                });\n            }\n            // Ensure a Redis campaign definition exists (worker requires it)\n            const hasDef = await ensureCampaignDefinition(id, campaign);\n            if (!hasDef) {\n                return res.status(500).json({\n                    error: \"Missing campaign definition in Redis and unable to construct one from campaign document. Retry cannot proceed.\"\n                });\n            }\n            // Find the ledger row\n            let contactObjId;\n            try {\n                // try parse as ObjectId first\n                contactObjId = new mongodb__WEBPACK_IMPORTED_MODULE_3__.ObjectId(contactId);\n            } catch  {\n                // fallback: use raw string\n                contactObjId = contactId;\n            }\n            const doc = await db.collection(\"campaign_contacts\").findOne({\n                campaignId: campaignObjectId,\n                contactId: contactObjId\n            });\n            if (!doc) {\n                return res.status(404).json({\n                    error: \"Contact ledger row not found for campaign\"\n                });\n            }\n            if (doc.status !== \"failed\") {\n                return res.status(400).json({\n                    error: \"Contact is not in failed state\"\n                });\n            }\n            if ((doc.attempts || 0) >= MAX_ATTEMPTS) {\n                return res.status(400).json({\n                    error: \"Contact has reached max attempts and cannot be retried\"\n                });\n            }\n            // Update single doc to pending\n            await db.collection(\"campaign_contacts\").updateOne({\n                _id: doc._id\n            }, {\n                $set: {\n                    status: \"pending\",\n                    lastError: null\n                }\n            });\n            // Enqueue appropriate job (use doc.step if present)\n            try {\n                if (doc.step) {\n                    await queue.add(\"followup\", {\n                        campaignId: id,\n                        contactId: contactObjId.toString ? contactObjId.toString() : String(contactObjId),\n                        step: doc.step\n                    }, {\n                        removeOnComplete: true,\n                        removeOnFail: true\n                    });\n                } else {\n                    await queue.add(\"initial\", {\n                        campaignId: id,\n                        contactId: contactObjId.toString ? contactObjId.toString() : String(contactObjId)\n                    }, {\n                        removeOnComplete: true,\n                        removeOnFail: true\n                    });\n                }\n            } catch (e) {\n                console.warn(\"Failed to enqueue retry job for contact\", e);\n                // We already set status to pending — if enqueue fails, we can roll back to failed (best-effort)\n                try {\n                    await db.collection(\"campaign_contacts\").updateOne({\n                        _id: doc._id\n                    }, {\n                        $set: {\n                            status: \"failed\",\n                            lastError: \"enqueue-failed\"\n                        }\n                    });\n                } catch (_) {}\n                return res.status(500).json({\n                    error: \"Failed to enqueue retry job\"\n                });\n            }\n            // Update redis counters: decrease failed by 1 if possible\n            try {\n                const currentFailed = await safeGetMetaInt(redisKey, \"failed\");\n                if (currentFailed > 0) {\n                    await _lib_redis__WEBPACK_IMPORTED_MODULE_1__.redis.hincrby(redisKey, \"failed\", -1);\n                }\n            } catch (e) {\n                console.warn(\"Failed to update redis counters during retryContact\", e);\n            }\n            await safePublish(\"campaign:new\", {\n                id,\n                action: \"retryContact\",\n                contactId\n            });\n            return res.status(200).json({\n                ok: true,\n                retried: 1,\n                contactId\n            });\n        }\n        // Should not reach here\n        return res.status(400).json({\n            error: \"Unsupported action\"\n        });\n    } catch (err) {\n        console.error(\"Campaign control error\", err);\n        return res.status(500).json({\n            error: \"Internal server error\"\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9wYWdlcy9hcGkvY2FtcGFpZ24vW2lkXS9jb250cm9sLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFDa0Q7QUFDSjtBQUNmO0FBQ0k7QUFFbkMsTUFBTUksUUFBUSxJQUFJRix5Q0FBS0EsQ0FBQyxhQUFhO0lBQUVHLFlBQVlKLDZDQUFLQTtBQUFDO0FBRXpELDhDQUE4QztBQUM5QyxNQUFNSyxlQUFlQyxPQUFPQyxRQUFRQyxHQUFHLENBQUNILFlBQVksSUFBSTtBQUN4RCxnREFBZ0Q7QUFDaEQsTUFBTUksb0JBQW9CSCxPQUFPQyxRQUFRQyxHQUFHLENBQUNDLGlCQUFpQixJQUFJO0FBSWxFLGVBQWVDLFNBQVNDLEdBQVcsRUFBRUMsR0FBMkI7SUFDOUQsSUFBSTtRQUNGLE1BQU1aLDZDQUFLQSxDQUFDYSxJQUFJLENBQUNGLEtBQUtDO0lBQ3hCLEVBQUUsT0FBT0UsS0FBSztRQUNaQyxRQUFRQyxJQUFJLENBQUMsd0NBQXdDRjtJQUN2RDtBQUNGO0FBRUEsZUFBZUcsWUFBWUMsT0FBZSxFQUFFQyxPQUFZO0lBQ3RELElBQUk7UUFDRixNQUFNbkIsNkNBQUtBLENBQUNvQixPQUFPLENBQUNGLFNBQVNHLEtBQUtDLFNBQVMsQ0FBQ0g7SUFDOUMsRUFBRSxPQUFPTCxLQUFLO1FBQ1pDLFFBQVFDLElBQUksQ0FBQyx3QkFBd0JGO0lBQ3ZDO0FBQ0Y7QUFFQSxvRUFBb0U7QUFDcEUsZUFBZVMsNEJBQTRCQyxVQUFrQjtJQUMzRCxJQUFJO1FBQ0Ysa0NBQWtDO1FBQ2xDLE1BQU1DLE9BQU8sTUFBTXRCLE1BQU11QixPQUFPLENBQzlCO1lBQUM7WUFBVztZQUFXO1lBQVU7U0FBUyxFQUMxQyxHQUNBLENBQUM7UUFHSCxNQUFNQyxVQUFVRixLQUFLRyxNQUFNLENBQUMsQ0FBQ0M7WUFDM0IsSUFBSTtnQkFDRixPQUFPQSxFQUFFQyxJQUFJLEVBQUVOLGVBQWVBO1lBQ2hDLEVBQUUsT0FBTTtnQkFDTixPQUFPO1lBQ1Q7UUFDRjtRQUVBLEtBQUssTUFB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QjtRQUN4QixPQUFPUixJQUFJRSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO1lBQUVDLE9BQU87UUFBcUI7SUFDNUQsRUFBRSxPQUFPdEQsS0FBSztRQUNaQyxRQUFRcUQsS0FBSyxDQUFDLDBCQUEwQnREO1FBQ3hDLE9BQU9rRCxJQUFJRSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO1lBQUVDLE9BQU87UUFBd0I7SUFDL0Q7QUFDRiIsInNvdXJjZXMiOlsid2VicGFjazovL21hcmtldGluZy1tdnAvLi9wYWdlcy9hcGkvY2FtcGFpZ24vW2lkXS9jb250cm9sLnRzPzY3MTYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOZXh0QXBpUmVxdWVzdCwgTmV4dEFwaVJlc3BvbnNlIH0gZnJvbSAnbmV4dCc7XHJcbmltcG9ydCBjbGllbnRQcm9taXNlIGZyb20gJy4uLy4uLy4uLy4uL2xpYi9tb25nbyc7XHJcbmltcG9ydCB7IHJlZGlzIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL3JlZGlzJztcclxuaW1wb3J0IHsgUXVldWUgfSBmcm9tICdidWxsbXEnO1xyXG5pbXBvcnQgeyBPYmplY3RJZCB9IGZyb20gJ21vbmdvZGInO1xyXG5cclxuY29uc3QgcXVldWUgPSBuZXcgUXVldWUoJ2NhbXBhaWducycsIHsgY29ubmVjdGlvbjogcmVkaXMgfSk7XHJcblxyXG4vLyBrZWVwIHBhcml0eSB3aXRoIHdvcmtlcjsgYWxsb3cgZW52IG92ZXJyaWRlXHJcbmNvbnN0IE1BWF9BVFRFTVBUUyA9IE51bWJlcihwcm9jZXNzLmVudi5NQVhfQVRURU1QVFMgfHwgMyk7XHJcbi8vIHNlcnZlci1zaWRlIGNhcCBmb3IgYmF0Y2ggcmV0cmllcyBwZXIgcmVxdWVzdFxyXG5jb25zdCBCQVRDSF9SRVRSWV9MSU1JVCA9IE51bWJlcihwcm9jZXNzLmVudi5CQVRDSF9SRVRSWV9MSU1JVCB8fCA1MDAwKTtcclxuXHJcbnR5cGUgQWN0aW9uID0gJ3BhdXNlJyB8ICdyZXN1bWUnIHwgJ2NhbmNlbCcgfCAnZGVsZXRlJyB8ICdyZXRyeUZhaWxlZCcgfCAncmV0cnlDb250YWN0JztcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHNhZmVIU2V0KGtleTogc3RyaW5nLCBvYmo6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHtcclxuICB0cnkge1xyXG4gICAgYXdhaXQgcmVkaXMuaHNldChrZXksIG9iaik7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBjb25zb2xlLndhcm4oJ1JlZGlzIHVuYXZhaWxhYmxlIHdoaWxlIHNldHRpbmcgbWV0YScsIGVycik7XHJcbiAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBzYWZlUHVibGlzaChjaGFubmVsOiBzdHJpbmcsIHBheWxvYWQ6IGFueSkge1xyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCByZWRpcy5wdWJsaXNoKGNoYW5uZWwsIEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGNvbnNvbGUud2FybignUmVkaXMgcHVibGlzaCBmYWlsZWQnLCBlcnIpO1xyXG4gIH1cclxufVxyXG5cclxuLy8gUmVtb3ZlIHdhaXRpbmcvZGVsYXllZC9hY3RpdmUgam9icyBmb3IgYSBjYW1wYWlnbklkIChiZXN0LWVmZm9ydClcclxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlUXVldWVkSm9ic0ZvckNhbXBhaWduKGNhbXBhaWduSWQ6IHN0cmluZykge1xyXG4gIHRyeSB7XHJcbiAgICAvLyBnZXQgd2FpdGluZy9kZWxheWVkL2FjdGl2ZSBqb2JzXHJcbiAgICBjb25zdCBqb2JzID0gYXdhaXQgcXVldWUuZ2V0Sm9icyhcclxuICAgICAgWyd3YWl0aW5nJywgJ2RlbGF5ZWQnLCAnYWN0aXZlJywgJ3BhdXNlZCddLFxyXG4gICAgICAwLFxyXG4gICAgICAtMVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBtYXRjaGVkID0gam9icy5maWx0ZXIoKGopID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICByZXR1cm4gai5kYXRhPy5jYW1wYWlnbklkID09PSBjYW1wYWlnbklkO1xyXG4gICAgICB9IGNhdGNoIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGZvciAoY29uc3QgaiBvZiBtYXRjaGVkKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gaWYgdGhlIGpvYiBpcyBhY3RpdmUsIHJlbW92ZSBtYXkgZmFpbCAtIHN0aWxsIHRyeVxyXG4gICAgICAgIGF3YWl0IGoucmVtb3ZlKCk7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAvLyBiZXN0LWVmZm9ydCDigJQgaWdub3JlXHJcbiAgICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gcmVtb3ZlIGpvYiAke2ouaWR9YCwgZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBtYXRjaGVkLmxlbmd0aDtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGVudW1lcmF0ZS9yZW1vdmUgam9icyBmb3IgY2FtcGFpZ24nLCBlcnIpO1xyXG4gICAgcmV0dXJuIDA7XHJcbiAgfVxyXG59XHJcblxyXG4vLyBzYWZlIHJlYWQgb2YgcmVkaXMgbWV0YSBpbnRlZ2VyIGZpZWxkXHJcbmFzeW5jIGZ1bmN0aW9uIHNhZmVHZXRNZXRhSW50KHJlZGlzS2V5OiBzdHJpbmcsIGZpZWxkOiBzdHJpbmcpIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgdiA9IGF3YWl0IHJlZGlzLmhnZXQocmVkaXNLZXksIGZpZWxkKTtcclxuICAgIHJldHVybiBOdW1iZXIodiB8fCAwKTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBFbnN1cmUgdGhlcmUgaXMgYSB1c2FibGUgYGNhbXBhaWduOntpZH06ZGVmaW5pdGlvbmAgaW4gUmVkaXMuXHJcbiAqIElmIG1pc3NpbmcsIGF0dGVtcHQgdG8gY29uc3RydWN0IG9uZSBmcm9tIHRoZSBNb25nbyBjYW1wYWlnbiBkb2N1bWVudC5cclxuICogUmV0dXJucyB0cnVlIGlmIGRlZmluaXRpb24gZXhpc3RzIG9yIHdhcyB3cml0dGVuIHN1Y2Nlc3NmdWxseS5cclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGVuc3VyZUNhbXBhaWduRGVmaW5pdGlvbihpZDogc3RyaW5nLCBjYW1wYWlnbkRvYzogYW55KTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgY29uc3Qga2V5ID0gYGNhbXBhaWduOiR7aWR9OmRlZmluaXRpb25gO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHJlZGlzLmdldChrZXkpO1xyXG4gICAgaWYgKGV4aXN0aW5nKSByZXR1cm4gdHJ1ZTtcclxuXHJcbiAgICAvLyBBdHRlbXB0IHRvIGJ1aWxkIGEgbWluaW1hbCBjb21wYXRpYmxlIGRlZmluaXRpb25cclxuICAgIC8vIFdvcmtlciBleHBlY3RzIHsgaW5pdGlhbDogeyBzdWJqZWN0LCBib2R5IH0sIGZvbGxvd1VwczogWy4uLl0gfVxyXG4gICAgbGV0IGJ1aWx0OiBhbnkgPSBudWxsO1xyXG5cclxuICAgIC8vIFByZWZlciBleHBsaWNpdCBzaGFwZXMgY29tbW9ubHkgdXNlZFxyXG4gICAgaWYgKGNhbXBhaWduRG9jPy5kZWZpbml0aW9uICYmIHR5cGVvZiBjYW1wYWlnbkRvYy5kZWZpbml0aW9uID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBidWlsdCA9IGNhbXBhaWduRG9jLmRlZmluaXRpb247XHJcbiAgICB9IGVsc2UgaWYgKGNhbXBhaWduRG9jPy5pbml0aWFsICYmIHR5cGVvZiBjYW1wYWlnbkRvYy5pbml0aWFsID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBidWlsdCA9IHsgaW5pdGlhbDogY2FtcGFpZ25Eb2MuaW5pdGlhbCwgZm9sbG93VXBzOiBjYW1wYWlnbkRvYy5mb2xsb3dVcHMgfHwgW10gfTtcclxuICAgIH0gZWxzZSBpZiAoY2FtcGFpZ25Eb2M/LnRlbXBsYXRlICYmIHR5cGVvZiBjYW1wYWlnbkRvYy50ZW1wbGF0ZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgYnVpbHQgPSB7IGluaXRpYWw6IHsgc3ViamVjdDogY2FtcGFpZ25Eb2MudGVtcGxhdGUuc3ViamVjdCB8fCBjYW1wYWlnbkRvYy5uYW1lLCBib2R5OiBjYW1wYWlnbkRvYy50ZW1wbGF0ZS5ib2R5IHx8IGNhbXBhaWduRG9jLmNvbnRlbnQgfHwgJycgfSwgZm9sbG93VXBzOiBjYW1wYWlnbkRvYy50ZW1wbGF0ZS5mb2xsb3dVcHMgfHwgY2FtcGFpZ25Eb2MuZm9sbG93VXBzIHx8IFtdIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBmYWxsYmFjazogdHJ5IHRvIGdsZWFuIHN1YmplY3QvYm9keSBmcm9tIGNvbW1vbiBmaWVsZHNcclxuICAgICAgY29uc3Qgc3ViamVjdCA9IGNhbXBhaWduRG9jPy5zdWJqZWN0IHx8IGNhbXBhaWduRG9jPy50aXRsZSB8fCBjYW1wYWlnbkRvYz8ubmFtZSB8fCBgQ2FtcGFpZ24gJHtpZH1gO1xyXG4gICAgICBjb25zdCBib2R5ID0gY2FtcGFpZ25Eb2M/LmJvZHkgfHwgY2FtcGFpZ25Eb2M/LmNvbnRlbnQgfHwgY2FtcGFpZ25Eb2M/Lmh0bWwgfHwgJyc7XHJcbiAgICAgIGNvbnN0IGZvbGxvd1VwcyA9IGNhbXBhaWduRG9jPy5mb2xsb3dVcHMgfHwgY2FtcGFpZ25Eb2M/LnN0ZXBzIHx8IFtdO1xyXG4gICAgICBidWlsdCA9IHsgaW5pdGlhbDogeyBzdWJqZWN0LCBib2R5IH0sIGZvbGxvd1VwcyB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIElmIGJ1aWx0IGRvZXNuJ3QgbG9vayByaWdodCAobm8gaW5pdGlhbCBzdWJqZWN0L2JvZHkpLCBmYWlsIHNhZmVcclxuICAgIGlmICghYnVpbHQgfHwgIWJ1aWx0LmluaXRpYWwgfHwgKGJ1aWx0LmluaXRpYWwuc3ViamVjdCA9PSBudWxsICYmIGJ1aWx0LmluaXRpYWwuYm9keSA9PSBudWxsKSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBjb25zdHJ1Y3QgY2FtcGFpZ24gZGVmaW5pdGlvbiBmcm9tIGNhbXBhaWduIGRvY3VtZW50JywgeyBjYW1wYWlnbklkOiBpZCwgc2FtcGxlOiBjYW1wYWlnbkRvYyA/IE9iamVjdC5rZXlzKGNhbXBhaWduRG9jKS5zbGljZSgwLCA4KSA6IG51bGwgfSk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQZXJzaXN0IGludG8gUmVkaXMgKG5vIGV4cGlyeSkgc28gd29ya2VyIGNhbiByZWFkIGl0XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCByZWRpcy5zZXQoa2V5LCBKU09OLnN0cmluZ2lmeShidWlsdCkpO1xyXG4gICAgICBjb25zb2xlLmxvZyhgV3JvdGUgZmFsbGJhY2sgY2FtcGFpZ24gZGVmaW5pdGlvbiBpbnRvIHJlZGlzIGZvciAke2lkfWApO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gd3JpdGUgY2FtcGFpZ24gZGVmaW5pdGlvbiB0byByZWRpcycsIGUpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgY29uc29sZS53YXJuKCdFcnJvciBjaGVja2luZy93cml0aW5nIGNhbXBhaWduIGRlZmluaXRpb24gaW4gcmVkaXMnLCBlKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXHJcbiAgcmVxOiBOZXh0QXBpUmVxdWVzdCxcclxuICByZXM6IE5leHRBcGlSZXNwb25zZVxyXG4pIHtcclxuICBpZiAocmVxLm1ldGhvZCAhPT0gJ1BPU1QnKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDUpLmpzb24oeyBlcnJvcjogJ01ldGhvZCBub3QgYWxsb3dlZCcgfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCB7IGlkIH0gPSByZXEucXVlcnk7XHJcbiAgaWYgKCFpZCB8fCB0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0ludmFsaWQgY2FtcGFpZ24gaWQnIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgeyBhY3Rpb24sIGNvbmZpcm0sIGNvbnRhY3RJZCB9ID0gcmVxLmJvZHkgYXMge1xyXG4gICAgYWN0aW9uPzogQWN0aW9uO1xyXG4gICAgY29uZmlybT86IGJvb2xlYW47XHJcbiAgICBjb250YWN0SWQ/OiBzdHJpbmc7XHJcbiAgfTtcclxuXHJcbiAgaWYgKCFhY3Rpb24gfHwgIVsncGF1c2UnLCAncmVzdW1lJywgJ2NhbmNlbCcsICdkZWxldGUnLCAncmV0cnlGYWlsZWQnLCAncmV0cnlDb250YWN0J10uaW5jbHVkZXMoYWN0aW9uKSkge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdJbnZhbGlkIGFjdGlvbicgfSk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBjbGllbnQgPSBhd2FpdCBjbGllbnRQcm9taXNlO1xyXG4gIGNvbnN0IGRiID0gY2xpZW50LmRiKCdQbGF0Zm9ybURhdGEnKTtcclxuICBjb25zdCBjYW1wYWlnbk9iamVjdElkID0gbmV3IE9iamVjdElkKGlkKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIFJlbG9hZCBjYW1wYWlnbiBmcm9tIE1vbmdvIChhdXRob3JpdGF0aXZlKVxyXG4gICAgY29uc3QgY2FtcGFpZ24gPSBhd2FpdCBkYlxyXG4gICAgICAuY29sbGVjdGlvbignY2FtcGFpZ25zJylcclxuICAgICAgLmZpbmRPbmUoeyBfaWQ6IGNhbXBhaWduT2JqZWN0SWQgfSk7XHJcblxyXG4gICAgaWYgKCFjYW1wYWlnbikge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogJ0NhbXBhaWduIG5vdCBmb3VuZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTGlnaHR3ZWlnaHQgaGVscGVyc1xyXG4gICAgY29uc3QgcmVkaXNLZXkgPSBgY2FtcGFpZ246JHtpZH06bWV0YWA7XHJcblxyXG4gICAgLy8gQUNUSU9OOiBQYXVzZVxyXG4gICAgaWYgKGFjdGlvbiA9PT0gJ3BhdXNlJykge1xyXG4gICAgICBpZiAoY2FtcGFpZ24uc3RhdHVzID09PSAncGF1c2VkJykge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7IG9rOiB0cnVlLCBtZXNzYWdlOiAnQWxyZWFkeSBwYXVzZWQnIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGF3YWl0IGRiLmNvbGxlY3Rpb24oJ2NhbXBhaWducycpLnVwZGF0ZU9uZShcclxuICAgICAgICB7IF9pZDogY2FtcGFpZ25PYmplY3RJZCB9LFxyXG4gICAgICAgIHsgJHNldDogeyBzdGF0dXM6ICdwYXVzZWQnIH0gfVxyXG4gICAgICApO1xyXG4gICAgICBhd2FpdCBzYWZlSFNldChyZWRpc0tleSwgeyBzdGF0dXM6ICdwYXVzZWQnIH0pO1xyXG4gICAgICBhd2FpdCBzYWZlUHVibGlzaCgnY2FtcGFpZ246bmV3JywgeyBpZCwgc3RhdHVzOiAncGF1c2VkJyB9KTtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgb2s6IHRydWUsIGFjdGlvbjogJ3BhdXNlZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQUNUSU9OOiBSZXN1bWVcclxuICAgIGlmIChhY3Rpb24gPT09ICdyZXN1bWUnKSB7XHJcbiAgICAgIGlmIChjYW1wYWlnbi5zdGF0dXMgPT09ICdydW5uaW5nJykge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7IG9rOiB0cnVlLCBtZXNzYWdlOiAnQWxyZWFkeSBydW5uaW5nJyB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgYXdhaXQgZGIuY29sbGVjdGlvbignY2FtcGFpZ25zJykudXBkYXRlT25lKFxyXG4gICAgICAgIHsgX2lkOiBjYW1wYWlnbk9iamVjdElkIH0sXHJcbiAgICAgICAgeyAkc2V0OiB7IHN0YXR1czogJ3J1bm5pbmcnIH0gfVxyXG4gICAgICApO1xyXG4gICAgICBhd2FpdCBzYWZlSFNldChyZWRpc0tleSwgeyBzdGF0dXM6ICdydW5uaW5nJyB9KTtcclxuICAgICAgYXdhaXQgc2FmZVB1Ymxpc2goJ2NhbXBhaWduOm5ldycsIHsgaWQsIHN0YXR1czogJ3J1bm5pbmcnIH0pO1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBvazogdHJ1ZSwgYWN0aW9uOiAncmVzdW1lZCcgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQUNUSU9OOiBDYW5jZWxcclxuICAgIGlmIChhY3Rpb24gPT09ICdjYW5jZWwnKSB7XHJcbiAgICAgIGlmIChjYW1wYWlnbi5zdGF0dXMgPT09ICdjYW5jZWxsZWQnKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc1xyXG4gICAgICAgICAgLnN0YXR1cygyMDApXHJcbiAgICAgICAgICAuanNvbih7IG9rOiB0cnVlLCBtZXNzYWdlOiAnQWxyZWFkeSBjYW5jZWxsZWQnIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyAxKSBNYXJrIGNhbXBhaWduIGNhbmNlbGxlZCBhbmQgY29tcGxldGVkQXRcclxuICAgICAgY29uc3QgY29tcGxldGVkQXQgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKCdjYW1wYWlnbnMnKS51cGRhdGVPbmUoXHJcbiAgICAgICAgeyBfaWQ6IGNhbXBhaWduT2JqZWN0SWQgfSxcclxuICAgICAgICB7ICRzZXQ6IHsgc3RhdHVzOiAnY2FuY2VsbGVkJywgY29tcGxldGVkQXQgfSB9XHJcbiAgICAgICk7XHJcbiAgICAgIGF3YWl0IHNhZmVIU2V0KHJlZGlzS2V5LCB7IHN0YXR1czogJ2NhbmNlbGxlZCcgfSk7XHJcblxyXG4gICAgICAvLyAyKSBGaW5kIGFuZCBhdG9taWNhbGx5IG1hcmsgcGVuZGluZyBsZWRnZXIgcm93cyBhcyBmYWlsZWQgKHNpbmdsZSB1cGRhdGVNYW55KVxyXG4gICAgICBjb25zdCBmaWx0ZXIgPSB7IGNhbXBhaWduSWQ6IGNhbXBhaWduT2JqZWN0SWQsIHN0YXR1czogJ3BlbmRpbmcnIH07XHJcbiAgICAgIGNvbnN0IHVwZGF0ZSA9IHtcclxuICAgICAgICAkc2V0OiB7XHJcbiAgICAgICAgICBzdGF0dXM6ICdmYWlsZWQnLFxyXG4gICAgICAgICAgbGFzdEVycm9yOiAnY2FuY2VsbGVkJyxcclxuICAgICAgICAgIGxhc3RBdHRlbXB0QXQ6IGNvbXBsZXRlZEF0LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJGluYzogeyBhdHRlbXB0czogMSB9LFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgdXBkYXRlUmVzdWx0ID0gYXdhaXQgZGJcclxuICAgICAgICAuY29sbGVjdGlvbignY2FtcGFpZ25fY29udGFjdHMnKVxyXG4gICAgICAgIC51cGRhdGVNYW55KGZpbHRlciwgdXBkYXRlKTtcclxuXHJcbiAgICAgIGNvbnN0IGNhbmNlbGxlZENvdW50ID0gdXBkYXRlUmVzdWx0Lm1vZGlmaWVkQ291bnQgPz8gMDtcclxuXHJcbiAgICAgIC8vIDMpIFVwZGF0ZSBSZWRpcyBjb3VudGVycyAoYmVzdC1lZmZvcnQpXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKGNhbmNlbGxlZENvdW50ID4gMCkge1xyXG4gICAgICAgICAgYXdhaXQgcmVkaXMuaGluY3JieShyZWRpc0tleSwgJ3Byb2Nlc3NlZCcsIGNhbmNlbGxlZENvdW50KTtcclxuICAgICAgICAgIGF3YWl0IHJlZGlzLmhpbmNyYnkocmVkaXNLZXksICdmYWlsZWQnLCBjYW5jZWxsZWRDb3VudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gdXBkYXRlIHJlZGlzIGNvdW50ZXJzIGR1cmluZyBjYW5jZWwnLCBlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gNCkgUGVyc2lzdCB0b3RhbHMgc25hcHNob3QgdG8gY2FtcGFpZ25zLnRvdGFscyAocmVhZCByZWRpcyBpZiBhdmFpbGFibGUsIGZhbGxiYWNrIHRvIGRiKVxyXG4gICAgICBsZXQgbWV0YSA9IHt9O1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIG1ldGEgPSAoYXdhaXQgcmVkaXMuaGdldGFsbChyZWRpc0tleSkpIHx8IHt9O1xyXG4gICAgICB9IGNhdGNoIHtcclxuICAgICAgICBtZXRhID0ge307XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIENvbXB1dGUgdG90YWxzIGZpbmFsIHZhbHVlcyBjb21iaW5pbmcgcGVyc2lzdGVkIHRvdGFscyBhbmQgb3VyIGNhbmNlbGxlZENvdW50IGFzIGZhbGxiYWNrXHJcbiAgICAgIGNvbnN0IHByb2Nlc3NlZE5vdyA9IE51bWJlcihtZXRhWydwcm9jZXNzZWQnXSA/PyAoY2FtcGFpZ24udG90YWxzPy5wcm9jZXNzZWQgPz8gMCkgKyBjYW5jZWxsZWRDb3VudCk7XHJcbiAgICAgIGNvbnN0IHNlbnROb3cgPSBOdW1iZXIobWV0YVsnc2VudCddID8/IChjYW1wYWlnbi50b3RhbHM/LnNlbnQgPz8gMCkpO1xyXG4gICAgICBjb25zdCBmYWlsZWROb3cgPSBOdW1iZXIobWV0YVsnZmFpbGVkJ10gPz8gKGNhbXBhaWduLnRvdGFscz8uZmFpbGVkID8/IDApICsgY2FuY2VsbGVkQ291bnQpO1xyXG5cclxuICAgICAgYXdhaXQgZGIuY29sbGVjdGlvbignY2FtcGFpZ25zJykudXBkYXRlT25lKFxyXG4gICAgICAgIHsgX2lkOiBjYW1wYWlnbk9iamVjdElkIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgJHNldDoge1xyXG4gICAgICAgICAgICAndG90YWxzLnByb2Nlc3NlZCc6IHByb2Nlc3NlZE5vdyxcclxuICAgICAgICAgICAgJ3RvdGFscy5zZW50Jzogc2VudE5vdyxcclxuICAgICAgICAgICAgJ3RvdGFscy5mYWlsZWQnOiBmYWlsZWROb3csXHJcbiAgICAgICAgICAgIGNvbXBsZXRlZEF0LFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyA1KSBSZW1vdmUgcXVldWVkIGpvYnMgZm9yIHRoaXMgY2FtcGFpZ24gKGJlc3QtZWZmb3J0KVxyXG4gICAgICBjb25zdCByZW1vdmVkSm9icyA9IGF3YWl0IHJlbW92ZVF1ZXVlZEpvYnNGb3JDYW1wYWlnbihpZCk7XHJcblxyXG4gICAgICAvLyA2KSBQdWJsaXNoIGV2ZW50XHJcbiAgICAgIGF3YWl0IHNhZmVQdWJsaXNoKCdjYW1wYWlnbjpuZXcnLCB7IGlkLCBzdGF0dXM6ICdjYW5jZWxsZWQnLCBjYW5jZWxsZWRDb3VudCwgcmVtb3ZlZEpvYnMgfSk7XHJcblxyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xyXG4gICAgICAgIG9rOiB0cnVlLFxyXG4gICAgICAgIGFjdGlvbjogJ2NhbmNlbGxlZCcsXHJcbiAgICAgICAgY2FuY2VsbGVkQ291bnQsXHJcbiAgICAgICAgcmVtb3ZlZEpvYnMsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFDVElPTjogRGVsZXRlXHJcbiAgICBpZiAoYWN0aW9uID09PSAnZGVsZXRlJykge1xyXG4gICAgICAvLyBSZXF1aXJlIGV4cGxpY2l0IGNvbmZpcm1hdGlvbiDigJQgc2FmZWd1YXJkcyBpbiBVSSBtdXN0IHNldCBjb25maXJtPXRydWVcclxuICAgICAgaWYgKGNvbmZpcm0gIT09IHRydWUpIHtcclxuICAgICAgICByZXR1cm4gcmVzXHJcbiAgICAgICAgICAuc3RhdHVzKDQwMClcclxuICAgICAgICAgIC5qc29uKHsgZXJyb3I6ICdEZWxldGlvbiByZXF1aXJlcyBjb25maXJtPXRydWUgaW4gcmVxdWVzdCBib2R5JyB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUHJldmVudCBhY2NpZGVudGFsIGRlbGV0aW9uIHdoaWxlIHJ1bm5pbmdcclxuICAgICAgaWYgKGNhbXBhaWduLnN0YXR1cyA9PT0gJ3J1bm5pbmcnKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc1xyXG4gICAgICAgICAgLnN0YXR1cyg0MDApXHJcbiAgICAgICAgICAuanNvbih7IGVycm9yOiAnQ2FuY2VsIHRoZSBjYW1wYWlnbiBiZWZvcmUgZGVsZXRpb24nIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBSZW1vdmUgcXVldWVkIGpvYnMgKGJlc3QtZWZmb3J0KVxyXG4gICAgICBjb25zdCByZW1vdmVkSm9icyA9IGF3YWl0IHJlbW92ZVF1ZXVlZEpvYnNGb3JDYW1wYWlnbihpZCk7XHJcblxyXG4gICAgICAvLyBEZWxldGUgUmVkaXMga2V5cyAoYmVzdC1lZmZvcnQpXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgYXdhaXQgcmVkaXMuZGVsKGBjYW1wYWlnbjoke2lkfTptZXRhYCk7XHJcbiAgICAgICAgYXdhaXQgcmVkaXMuZGVsKGBjYW1wYWlnbjoke2lkfTpkZWZpbml0aW9uYCk7XHJcbiAgICAgICAgYXdhaXQgcmVkaXMuc3JlbSgnY2FtcGFpZ246YWxsJywgaWQpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdSZWRpcyBjbGVhbnVwIG9uIGRlbGV0ZSBmYWlsZWQnLCBlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gRGVsZXRlIE1vbmdvIGRvY3NcclxuICAgICAgY29uc3QgW2NhbXBhaWduRGVsLCBsZWRnZXJEZWxdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xyXG4gICAgICAgIGRiLmNvbGxlY3Rpb24oJ2NhbXBhaWducycpLmRlbGV0ZU9uZSh7IF9pZDogY2FtcGFpZ25PYmplY3RJZCB9KSxcclxuICAgICAgICBkYi5jb2xsZWN0aW9uKCdjYW1wYWlnbl9jb250YWN0cycpLmRlbGV0ZU1hbnkoeyBjYW1wYWlnbklkOiBjYW1wYWlnbk9iamVjdElkIH0pLFxyXG4gICAgICBdKTtcclxuXHJcbiAgICAgIGF3YWl0IHNhZmVQdWJsaXNoKCdjYW1wYWlnbjpuZXcnLCB7IGlkLCBzdGF0dXM6ICdkZWxldGVkJyB9KTtcclxuXHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgb2s6IHRydWUsXHJcbiAgICAgICAgYWN0aW9uOiAnZGVsZXRlZCcsXHJcbiAgICAgICAgY2FtcGFpZ25EZWxldGVkOiBjYW1wYWlnbkRlbC5kZWxldGVkQ291bnQgPz8gMCxcclxuICAgICAgICBsZWRnZXJEZWxldGVkOiBsZWRnZXJEZWwuZGVsZXRlZENvdW50ID8/IDAsXHJcbiAgICAgICAgcmVtb3ZlZEpvYnMsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEFDVElPTjogUmV0cnkgYWxsIGZhaWxlZCBjb250YWN0cyB0aGF0IGFyZSBiZWxvdyBNQVhfQVRURU1QVFNcclxuICAgIGlmIChhY3Rpb24gPT09ICdyZXRyeUZhaWxlZCcpIHtcclxuICAgICAgLy8gRGlzYWxsb3cgcmV0cnlpbmcgaWYgY2FtcGFpZ24gaXMgY2FuY2VsbGVkL2RlbGV0ZWRcclxuICAgICAgaWYgKGNhbXBhaWduLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcgfHwgY2FtcGFpZ24uc3RhdHVzID09PSAnZGVsZXRlZCcpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0Nhbm5vdCByZXRyeSBjb250YWN0cyBmb3IgY2FuY2VsbGVkL2RlbGV0ZWQgY2FtcGFpZ24nIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBFbnN1cmUgYSBSZWRpcyBjYW1wYWlnbiBkZWZpbml0aW9uIGV4aXN0cyAod29ya2VyIHJlcXVpcmVzIGl0KVxyXG4gICAgICBjb25zdCBoYXNEZWYgPSBhd2FpdCBlbnN1cmVDYW1wYWlnbkRlZmluaXRpb24oaWQsIGNhbXBhaWduKTtcclxuICAgICAgaWYgKCFoYXNEZWYpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ01pc3NpbmcgY2FtcGFpZ24gZGVmaW5pdGlvbiBpbiBSZWRpcyBhbmQgdW5hYmxlIHRvIGNvbnN0cnVjdCBvbmUgZnJvbSBjYW1wYWlnbiBkb2N1bWVudC4gUmV0cnkgY2Fubm90IHByb2NlZWQuJyB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gZmluZCBmYWlsZWQgY29udGFjdHMgd2l0aCBhdHRlbXB0cyA8IE1BWF9BVFRFTVBUU1xyXG4gICAgICBjb25zdCBmaWx0ZXIgPSB7IGNhbXBhaWduSWQ6IGNhbXBhaWduT2JqZWN0SWQsIHN0YXR1czogJ2ZhaWxlZCcsIGF0dGVtcHRzOiB7ICRsdDogTUFYX0FUVEVNUFRTIH0gfTtcclxuICAgICAgY29uc3QgZmFpbGVkRG9jcyA9IGF3YWl0IGRiXHJcbiAgICAgICAgLmNvbGxlY3Rpb24oJ2NhbXBhaWduX2NvbnRhY3RzJylcclxuICAgICAgICAuZmluZChmaWx0ZXIsIHsgcHJvamVjdGlvbjogeyBfaWQ6IDEsIGNvbnRhY3RJZDogMSwgc3RlcDogMSB9IH0pXHJcbiAgICAgICAgLnRvQXJyYXkoKTtcclxuXHJcbiAgICAgIGNvbnN0IHRvUmV0cnlDb3VudCA9IGZhaWxlZERvY3MubGVuZ3RoO1xyXG4gICAgICBpZiAodG9SZXRyeUNvdW50ID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgb2s6IHRydWUsIHJldHJpZWQ6IDAsIG1lc3NhZ2U6ICdObyBlbGlnaWJsZSBmYWlsZWQgY29udGFjdHMgdG8gcmV0cnknIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBzZXJ2ZXItc2lkZSBjYXAgZW5mb3JjZW1lbnRcclxuICAgICAgaWYgKHRvUmV0cnlDb3VudCA+IEJBVENIX1JFVFJZX0xJTUlUKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcclxuICAgICAgICAgIGVycm9yOiAnQmF0Y2ggcmV0cnkgZXhjZWVkcyBzZXJ2ZXIgbGltaXQnLFxyXG4gICAgICAgICAgbWVzc2FnZTogYFRyeWluZyB0byByZXRyeSAke3RvUmV0cnlDb3VudH0gY29udGFjdHMgZXhjZWVkcyBzZXJ2ZXIgY2FwIG9mICR7QkFUQ0hfUkVUUllfTElNSVR9LiBVc2UgcGFnaW5hdGlvbiB0byByZXRyeSBpbiBzbWFsbGVyIGJhdGNoZXMuYCxcclxuICAgICAgICAgIHRvUmV0cnlDb3VudCxcclxuICAgICAgICAgIGxpbWl0OiBCQVRDSF9SRVRSWV9MSU1JVCxcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQXRvbWljYWxseSBtYXJrIHRoZW0gcGVuZGluZyAoYSBzaW5nbGUgdXBkYXRlTWFueSlcclxuICAgICAgY29uc3QgdXBkYXRlUmVzdWx0ID0gYXdhaXQgZGIuY29sbGVjdGlvbignY2FtcGFpZ25fY29udGFjdHMnKS51cGRhdGVNYW55KGZpbHRlciwge1xyXG4gICAgICAgICRzZXQ6IHsgc3RhdHVzOiAncGVuZGluZycsIGxhc3RFcnJvcjogbnVsbCB9LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSB1cGRhdGVSZXN1bHQubW9kaWZpZWRDb3VudCA/PyAwO1xyXG5cclxuICAgICAgLy8gRW5xdWV1ZSBqb2JzIChiYXRjaClcclxuICAgICAgY29uc3Qgam9iczogUHJvbWlzZTxhbnk+W10gPSBbXTtcclxuICAgICAgY29uc3QgQ0hVTksgPSAyMDA7IC8vIHJlYXNvbmFibGUgY2h1bmtpbmdcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmYWlsZWREb2NzLmxlbmd0aDsgaSArPSBDSFVOSykge1xyXG4gICAgICAgIGNvbnN0IGNodW5rID0gZmFpbGVkRG9jcy5zbGljZShpLCBpICsgQ0hVTkspO1xyXG4gICAgICAgIGZvciAoY29uc3QgZG9jIG9mIGNodW5rKSB7XHJcbiAgICAgICAgICBjb25zdCBjb250YWN0T2JqSWQgPSBkb2MuY29udGFjdElkID8gZG9jLmNvbnRhY3RJZCA6IGRvYy5faWQ7XHJcbiAgICAgICAgICAvLyBEZXRlcm1pbmUgam9iIG5hbWUgYW5kIHBheWxvYWQ6IHByZWZlciBzdGVwIHBheWxvYWQgd2hlbiBwcmVzZW50XHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAoZG9jLnN0ZXApIHtcclxuICAgICAgICAgICAgICBqb2JzLnB1c2goXHJcbiAgICAgICAgICAgICAgICBxdWV1ZS5hZGQoXHJcbiAgICAgICAgICAgICAgICAgICdmb2xsb3d1cCcsXHJcbiAgICAgICAgICAgICAgICAgIHsgY2FtcGFpZ25JZDogaWQsIGNvbnRhY3RJZDogY29udGFjdE9iaklkLnRvU3RyaW5nID8gY29udGFjdE9iaklkLnRvU3RyaW5nKCkgOiBTdHJpbmcoY29udGFjdE9iaklkKSwgc3RlcDogZG9jLnN0ZXAgfSxcclxuICAgICAgICAgICAgICAgICAgeyByZW1vdmVPbkNvbXBsZXRlOiB0cnVlLCByZW1vdmVPbkZhaWw6IHRydWUgfVxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgam9icy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgcXVldWUuYWRkKFxyXG4gICAgICAgICAgICAgICAgICAnaW5pdGlhbCcsXHJcbiAgICAgICAgICAgICAgICAgIHsgY2FtcGFpZ25JZDogaWQsIGNvbnRhY3RJZDogY29udGFjdE9iaklkLnRvU3RyaW5nID8gY29udGFjdE9iaklkLnRvU3RyaW5nKCkgOiBTdHJpbmcoY29udGFjdE9iaklkKSB9LFxyXG4gICAgICAgICAgICAgICAgICB7IHJlbW92ZU9uQ29tcGxldGU6IHRydWUsIHJlbW92ZU9uRmFpbDogdHJ1ZSB9XHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBxdWV1ZSBqb2IgZm9yIHJldHJ5RmFpbGVkIGNodW5rIGl0ZW0nLCBlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFdhaXQgZm9yIGVucXVldWVzIChiZXN0LWVmZm9ydClcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChqb2JzKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignU29tZSBxdWV1ZS5hZGQgY2FsbHMgZmFpbGVkIGR1cmluZyByZXRyeUZhaWxlZCcsIGUpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBVcGRhdGUgcmVkaXMgY291bnRlcnM6IGRlY3JlYXNlIGZhaWxlZCBieSB1cGRhdGVkIChiZXN0LWVmZm9ydCwgYnV0IGF2b2lkIG5lZ2F0aXZlKVxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGYWlsZWQgPSBhd2FpdCBzYWZlR2V0TWV0YUludChyZWRpc0tleSwgJ2ZhaWxlZCcpO1xyXG4gICAgICAgIGNvbnN0IGRlYyA9IE1hdGgubWluKHVwZGF0ZWQsIGN1cnJlbnRGYWlsZWQpO1xyXG4gICAgICAgIGlmIChkZWMgPiAwKSB7XHJcbiAgICAgICAgICBhd2FpdCByZWRpcy5oaW5jcmJ5KHJlZGlzS2V5LCAnZmFpbGVkJywgLWRlYyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gdXBkYXRlIHJlZGlzIGNvdW50ZXJzIGR1cmluZyByZXRyeUZhaWxlZCcsIGUpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBhd2FpdCBzYWZlUHVibGlzaCgnY2FtcGFpZ246bmV3JywgeyBpZCwgYWN0aW9uOiAncmV0cnlGYWlsZWQnLCByZXRyaWVkOiB1cGRhdGVkIH0pO1xyXG5cclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgb2s6IHRydWUsIHJldHJpZWQ6IHVwZGF0ZWQsIGF0dGVtcHRlZEVucXVldWU6IHRvUmV0cnlDb3VudCB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBQ1RJT046IFJldHJ5IGEgc2luZ2xlIGZhaWxlZCBjb250YWN0IGJ5IGNvbnRhY3RJZFxyXG4gICAgaWYgKGFjdGlvbiA9PT0gJ3JldHJ5Q29udGFjdCcpIHtcclxuICAgICAgaWYgKCFjb250YWN0SWQgfHwgdHlwZW9mIGNvbnRhY3RJZCAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ01pc3NpbmcgY29udGFjdElkIGZvciByZXRyeUNvbnRhY3QnIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBEaXNhbGxvdyByZXRyeWluZyBpZiBjYW1wYWlnbiBpcyBjYW5jZWxsZWQvZGVsZXRlZFxyXG4gICAgICBpZiAoY2FtcGFpZ24uc3RhdHVzID09PSAnY2FuY2VsbGVkJyB8fCBjYW1wYWlnbi5zdGF0dXMgPT09ICdkZWxldGVkJykge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnQ2Fubm90IHJldHJ5IGNvbnRhY3RzIGZvciBjYW5jZWxsZWQvZGVsZXRlZCBjYW1wYWlnbicgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIEVuc3VyZSBhIFJlZGlzIGNhbXBhaWduIGRlZmluaXRpb24gZXhpc3RzICh3b3JrZXIgcmVxdWlyZXMgaXQpXHJcbiAgICAgIGNvbnN0IGhhc0RlZiA9IGF3YWl0IGVuc3VyZUNhbXBhaWduRGVmaW5pdGlvbihpZCwgY2FtcGFpZ24pO1xyXG4gICAgICBpZiAoIWhhc0RlZikge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnTWlzc2luZyBjYW1wYWlnbiBkZWZpbml0aW9uIGluIFJlZGlzIGFuZCB1bmFibGUgdG8gY29uc3RydWN0IG9uZSBmcm9tIGNhbXBhaWduIGRvY3VtZW50LiBSZXRyeSBjYW5ub3QgcHJvY2VlZC4nIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBGaW5kIHRoZSBsZWRnZXIgcm93XHJcbiAgICAgIGxldCBjb250YWN0T2JqSWQ7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gdHJ5IHBhcnNlIGFzIE9iamVjdElkIGZpcnN0XHJcbiAgICAgICAgY29udGFjdE9iaklkID0gbmV3IE9iamVjdElkKGNvbnRhY3RJZCk7XHJcbiAgICAgIH0gY2F0Y2gge1xyXG4gICAgICAgIC8vIGZhbGxiYWNrOiB1c2UgcmF3IHN0cmluZ1xyXG4gICAgICAgIGNvbnRhY3RPYmpJZCA9IGNvbnRhY3RJZDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgZG9jID0gYXdhaXQgZGIuY29sbGVjdGlvbignY2FtcGFpZ25fY29udGFjdHMnKS5maW5kT25lKHtcclxuICAgICAgICBjYW1wYWlnbklkOiBjYW1wYWlnbk9iamVjdElkLFxyXG4gICAgICAgIGNvbnRhY3RJZDogY29udGFjdE9iaklkLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGlmICghZG9jKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6ICdDb250YWN0IGxlZGdlciByb3cgbm90IGZvdW5kIGZvciBjYW1wYWlnbicgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChkb2Muc3RhdHVzICE9PSAnZmFpbGVkJykge1xyXG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiAnQ29udGFjdCBpcyBub3QgaW4gZmFpbGVkIHN0YXRlJyB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKChkb2MuYXR0ZW1wdHMgfHwgMCkgPj0gTUFYX0FUVEVNUFRTKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdDb250YWN0IGhhcyByZWFjaGVkIG1heCBhdHRlbXB0cyBhbmQgY2Fubm90IGJlIHJldHJpZWQnIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBVcGRhdGUgc2luZ2xlIGRvYyB0byBwZW5kaW5nXHJcbiAgICAgIGF3YWl0IGRiLmNvbGxlY3Rpb24oJ2NhbXBhaWduX2NvbnRhY3RzJykudXBkYXRlT25lKFxyXG4gICAgICAgIHsgX2lkOiBkb2MuX2lkIH0sXHJcbiAgICAgICAgeyAkc2V0OiB7IHN0YXR1czogJ3BlbmRpbmcnLCBsYXN0RXJyb3I6IG51bGwgfSB9XHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyBFbnF1ZXVlIGFwcHJvcHJpYXRlIGpvYiAodXNlIGRvYy5zdGVwIGlmIHByZXNlbnQpXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKGRvYy5zdGVwKSB7XHJcbiAgICAgICAgICBhd2FpdCBxdWV1ZS5hZGQoXHJcbiAgICAgICAgICAgICdmb2xsb3d1cCcsXHJcbiAgICAgICAgICAgIHsgY2FtcGFpZ25JZDogaWQsIGNvbnRhY3RJZDogY29udGFjdE9iaklkLnRvU3RyaW5nID8gY29udGFjdE9iaklkLnRvU3RyaW5nKCkgOiBTdHJpbmcoY29udGFjdE9iaklkKSwgc3RlcDogZG9jLnN0ZXAgfSxcclxuICAgICAgICAgICAgeyByZW1vdmVPbkNvbXBsZXRlOiB0cnVlLCByZW1vdmVPbkZhaWw6IHRydWUgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXdhaXQgcXVldWUuYWRkKFxyXG4gICAgICAgICAgICAnaW5pdGlhbCcsXHJcbiAgICAgICAgICAgIHsgY2FtcGFpZ25JZDogaWQsIGNvbnRhY3RJZDogY29udGFjdE9iaklkLnRvU3RyaW5nID8gY29udGFjdE9iaklkLnRvU3RyaW5nKCkgOiBTdHJpbmcoY29udGFjdE9iaklkKSB9LFxyXG4gICAgICAgICAgICB7IHJlbW92ZU9uQ29tcGxldGU6IHRydWUsIHJlbW92ZU9uRmFpbDogdHJ1ZSB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGVucXVldWUgcmV0cnkgam9iIGZvciBjb250YWN0JywgZSk7XHJcbiAgICAgICAgLy8gV2UgYWxyZWFkeSBzZXQgc3RhdHVzIHRvIHBlbmRpbmcg4oCUIGlmIGVucXVldWUgZmFpbHMsIHdlIGNhbiByb2xsIGJhY2sgdG8gZmFpbGVkIChiZXN0LWVmZm9ydClcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgYXdhaXQgZGIuY29sbGVjdGlvbignY2FtcGFpZ25fY29udGFjdHMnKS51cGRhdGVPbmUoXHJcbiAgICAgICAgICAgIHsgX2lkOiBkb2MuX2lkIH0sXHJcbiAgICAgICAgICAgIHsgJHNldDogeyBzdGF0dXM6ICdmYWlsZWQnLCBsYXN0RXJyb3I6ICdlbnF1ZXVlLWZhaWxlZCcgfSB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gY2F0Y2ggKF8pIHt9XHJcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6ICdGYWlsZWQgdG8gZW5xdWV1ZSByZXRyeSBqb2InIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBVcGRhdGUgcmVkaXMgY291bnRlcnM6IGRlY3JlYXNlIGZhaWxlZCBieSAxIGlmIHBvc3NpYmxlXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEZhaWxlZCA9IGF3YWl0IHNhZmVHZXRNZXRhSW50KHJlZGlzS2V5LCAnZmFpbGVkJyk7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRGYWlsZWQgPiAwKSB7XHJcbiAgICAgICAgICBhd2FpdCByZWRpcy5oaW5jcmJ5KHJlZGlzS2V5LCAnZmFpbGVkJywgLTEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIHVwZGF0ZSByZWRpcyBjb3VudGVycyBkdXJpbmcgcmV0cnlDb250YWN0JywgZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGF3YWl0IHNhZmVQdWJsaXNoKCdjYW1wYWlnbjpuZXcnLCB7IGlkLCBhY3Rpb246ICdyZXRyeUNvbnRhY3QnLCBjb250YWN0SWQgfSk7XHJcblxyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBvazogdHJ1ZSwgcmV0cmllZDogMSwgY29udGFjdElkIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFNob3VsZCBub3QgcmVhY2ggaGVyZVxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6ICdVbnN1cHBvcnRlZCBhY3Rpb24nIH0pO1xyXG4gIH0gY2F0Y2ggKGVycikge1xyXG4gICAgY29uc29sZS5lcnJvcignQ2FtcGFpZ24gY29udHJvbCBlcnJvcicsIGVycik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSk7XHJcbiAgfVxyXG59XHJcbiJdLCJuYW1lcyI6WyJjbGllbnRQcm9taXNlIiwicmVkaXMiLCJRdWV1ZSIsIk9iamVjdElkIiwicXVldWUiLCJjb25uZWN0aW9uIiwiTUFYX0FUVEVNUFRTIiwiTnVtYmVyIiwicHJvY2VzcyIsImVudiIsIkJBVENIX1JFVFJZX0xJTUlUIiwic2FmZUhTZXQiLCJrZXkiLCJvYmoiLCJoc2V0IiwiZXJyIiwiY29uc29sZSIsIndhcm4iLCJzYWZlUHVibGlzaCIsImNoYW5uZWwiLCJwYXlsb2FkIiwicHVibGlzaCIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZW1vdmVRdWV1ZWRKb2JzRm9yQ2FtcGFpZ24iLCJjYW1wYWlnbklkIiwiam9icyIsImdldEpvYnMiLCJtYXRjaGVkIiwiZmlsdGVyIiwiaiIsImRhdGEiLCJyZW1vdmUiLCJlIiwiaWQiLCJsZW5ndGgiLCJzYWZlR2V0TWV0YUludCIsInJlZGlzS2V5IiwiZmllbGQiLCJ2IiwiaGdldCIsImVuc3VyZUNhbXBhaWduRGVmaW5pdGlvbiIsImNhbXBhaWduRG9jIiwiZXhpc3RpbmciLCJnZXQiLCJidWlsdCIsImRlZmluaXRpb24iLCJpbml0aWFsIiwiZm9sbG93VXBzIiwidGVtcGxhdGUiLCJzdWJqZWN0IiwibmFtZSIsImJvZHkiLCJjb250ZW50IiwidGl0bGUiLCJodG1sIiwic3RlcHMiLCJzYW1wbGUiLCJPYmplY3QiLCJrZXlzIiwic2xpY2UiLCJzZXQiLCJsb2ciLCJoYW5kbGVyIiwicmVxIiwicmVzIiwibWV0aG9kIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwicXVlcnkiLCJhY3Rpb24iLCJjb25maXJtIiwiY29udGFjdElkIiwiaW5jbHVkZXMiLCJjbGllbnQiLCJkYiIsImNhbXBhaWduT2JqZWN0SWQiLCJjYW1wYWlnbiIsImNvbGxlY3Rpb24iLCJmaW5kT25lIiwiX2lkIiwib2siLCJtZXNzYWdlIiwidXBkYXRlT25lIiwiJHNldCIsImNvbXBsZXRlZEF0IiwiRGF0ZSIsInVwZGF0ZSIsImxhc3RFcnJvciIsImxhc3RBdHRlbXB0QXQiLCIkaW5jIiwiYXR0ZW1wdHMiLCJ1cGRhdGVSZXN1bHQiLCJ1cGRhdGVNYW55IiwiY2FuY2VsbGVkQ291bnQiLCJtb2RpZmllZENvdW50IiwiaGluY3JieSIsIm1ldGEiLCJoZ2V0YWxsIiwicHJvY2Vzc2VkTm93IiwidG90YWxzIiwicHJvY2Vzc2VkIiwic2VudE5vdyIsInNlbnQiLCJmYWlsZWROb3ciLCJmYWlsZWQiLCJyZW1vdmVkSm9icyIsImRlbCIsInNyZW0iLCJjYW1wYWlnbkRlbCIsImxlZGdlckRlbCIsIlByb21pc2UiLCJhbGwiLCJkZWxldGVPbmUiLCJkZWxldGVNYW55IiwiY2FtcGFpZ25EZWxldGVkIiwiZGVsZXRlZENvdW50IiwibGVkZ2VyRGVsZXRlZCIsImhhc0RlZiIsIiRsdCIsImZhaWxlZERvY3MiLCJmaW5kIiwicHJvamVjdGlvbiIsInN0ZXAiLCJ0b0FycmF5IiwidG9SZXRyeUNvdW50IiwicmV0cmllZCIsImxpbWl0IiwidXBkYXRlZCIsIkNIVU5LIiwiaSIsImNodW5rIiwiZG9jIiwiY29udGFjdE9iaklkIiwicHVzaCIsImFkZCIsInRvU3RyaW5nIiwiU3RyaW5nIiwicmVtb3ZlT25Db21wbGV0ZSIsInJlbW92ZU9uRmFpbCIsImN1cnJlbnRGYWlsZWQiLCJkZWMiLCJNYXRoIiwibWluIiwiYXR0ZW1wdGVkRW5xdWV1ZSIsIl8iXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(api)/./pages/api/campaign/[id]/control.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fcampaign%2F%5Bid%5D%2Fcontrol&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Ccampaign%5C%5Bid%5D%5Ccontrol.ts&middlewareConfigBase64=e30%3D!")));
module.exports = __webpack_exports__;

})();